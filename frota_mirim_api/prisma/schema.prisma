generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ENUMS

enum VehicleType {
  CARRO
  CAMINHAO
  MOTO
  ONIBUS
}

enum FuelType {
  GASOLINA
  ETANOL
  DIESEL
}

enum FuelStationType {
  INTERNO
  EXTERNO
}

// USER

model User {
  id           String  @id @default(uuid())
  firstName    String
  lastName     String
  email        String  @unique
  passwordHash String
  role         String  @default("admin")
  isActive     Boolean @default(true)

  imageUrl     String?
  cnhExpiresAt DateTime?

  abastecimentos FuelSupply[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([role])
}

// VEHICLE

model Vehicle {
  id     String      @id @default(uuid())
  placa  String      @unique
  modelo String
  marca  String
  ano    Int
  tipo   VehicleType

  kmAtual               Int
  kmUltimoAbastecimento Int?

  vencimentoDocumento DateTime
  vencimentoIPVA      DateTime

  isActive Boolean @default(true)

  abastecimentos FuelSupply[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tipo])
  @@index([isActive])
  @@index([vencimentoDocumento])
  @@index([vencimentoIPVA])
}

// FUEL SUPPLY (ABASTECIMENTO)

model FuelSupply {
  id String @id @default(uuid())

  // RELAÇÕES

  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // DADOS DO ABASTECIMENTO
  data DateTime
  kmAtual Int
  litros     Decimal @db.Decimal(10, 3)
  valorLitro Decimal @db.Decimal(10, 3)
  valorTotal Decimal @db.Decimal(12, 2)
  tipoCombustivel FuelType
  postoTipo       FuelStationType
  postoNome       String?
  tanqueCheio Boolean @default(false)

  // Média calculada somente quando tanqueCheio = true
  media Decimal? @db.Decimal(10, 3)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // INDEXAÇÃO PARA PERFORMANCE
  @@index([vehicleId])
  @@index([userId])
  @@index([data])
  @@index([tipoCombustivel])
  @@index([tanqueCheio])
}
